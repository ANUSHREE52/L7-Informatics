{% extends 'expenses/base.html' %}

{% block title %}{{ title }} - Expense Tracker{% endblock %}

{% block header %}{{ title }}{% endblock %}

{% block header_buttons %}
    <a href="{% url 'expenses:category_list' %}" class="btn btn-outline-secondary">
        <i class="bi bi-arrow-left"></i> Back to Categories
    </a>
{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-6">
        <div class="card">
            <div class="card-body">
                <form method="post" class="needs-validation" novalidate>
                    {% csrf_token %}
                    
                    {% if form.non_field_errors %}
                        <div class="alert alert-danger">
                            {% for error in form.non_field_errors %}
                                {{ error }}
                            {% endfor %}
                        </div>
                    {% endif %}
                    
                    <div class="mb-4">
                        <label for="{{ form.name.id_for_label }}" class="form-label">
                            {{ form.name.label }}
                            <span class="text-danger">*</span>
                        </label>
                        <input type="text" 
                               name="{{ form.name.name }}" 
                               id="{{ form.name.id_for_label }}" 
                               class="form-control{% if form.name.errors %} is-invalid{% endif %}" 
                               value="{{ form.name.value|default:'' }}" 
                               placeholder="e.g., Groceries, Rent, Transportation" 
                               required>
                        {% if form.name.errors %}
                            <div class="invalid-feedback">
                                {{ form.name.errors.0 }}
                            </div>
                        {% else %}
                            <div class="invalid-feedback">
                                Please provide a category name.
                            </div>
                        {% endif %}
                    </div>
                    
                    <div class="mb-4">
                        <label class="form-label">Color</label>
                        <div class="d-flex flex-wrap gap-2" id="colorPicker">
                            {% with default_colors='#4361ee,#3f37c9,#4cc9f0,#4895ef,#560bad,#480ca8,#3a0ca3,#3f37c9,#4361ee,#4895ef,#4cc9f0,#4cc9f0,#4895ef,#4361ee,#3f37c9,#3a0ca3,#480ca8,#560bad' %}
                                {% for color in default_colors.split %}
                                    <div class="form-check p-0" style="width: 30px; height: 30px;">
                                        <input class="form-check-input d-none" 
                                               type="radio" 
                                               name="color" 
                                               id="color{{ forloop.counter }}" 
                                               value="{{ color }}"
                                               {% if form.color.value == color or not form.color.value and forloop.first %}checked{% endif %}>
                                        <label class="form-check-label w-100 h-100 rounded" 
                                               for="color{{ forloop.counter }}" 
                                               style="background-color: {{ color }}; cursor: pointer;"
                                               data-bs-toggle="tooltip" 
                                               title="{{ color }}">
                                        </label>
                                    </div>
                                {% endfor %}
                            {% endwith %}
                            <div class="form-check p-0" style="width: 30px; height: 30px;">
                                <input class="form-check-input d-none" 
                                       type="radio" 
                                       name="color" 
                                       id="customColor" 
                                       value="{{ form.color.value|default:'#e9ecef' }}"
                                       {% if form.color.value and form.color.value not in default_colors %}checked{% endif %}>
                                <label class="form-check-label w-100 h-100 rounded d-flex align-items-center justify-content-center" 
                                       for="customColor" 
                                       style="background-color: {{ form.color.value|default:'#e9ecef' }}; cursor: pointer;"
                                       data-bs-toggle="tooltip" 
                                       title="Custom color">
                                    <i class="bi bi-eyedropper"></i>
                                </label>
                                <input type="color" 
                                       class="form-control-color d-none" 
                                       id="customColorInput" 
                                       value="{{ form.color.value|default:'#e9ecef' }}">
                            </div>
                        </div>
                        <input type="hidden" name="color" id="selectedColor" value="{{ form.color.value|default:'#4361ee' }}">
                        <div class="form-text">
                            Select a color to help identify this category.
                        </div>
                    </div>
                    
                    <div class="d-flex justify-content-between">
                        <a href="{% url 'expenses:category_list' %}" class="btn btn-outline-secondary">
                            <i class="bi bi-x-circle"></i> Cancel
                        </a>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-save"></i> Save Category
                        </button>
                    </div>
                </form>
            </div>
        </div>
        
        {% if object %}
            <div class="card mt-4">
                <div class="card-header">
                    Category Statistics
                </div>
                <div class="card-body">
                    <dl class="row">
                        <dt class="col-sm-6">Total Expenses:</dt>
                        <dd class="col-sm-6 text-end">{{ object.expense_count|default:0 }}</dd>
                        
                        <dt class="col-sm-6">Total Amount:</dt>
                        <dd class="col-sm-6 text-end">${{ object.total_spent|default:'0.00'|floatformat:2 }}</dd>
                        
                        <dt class="col-sm-6">Last Used:</dt>
                        <dd class="col-sm-6 text-end">
                            {% if object.last_used %}
                                {{ object.last_used|date:"M d, Y" }}
                            {% else %}
                                Never
                            {% endif %}
                        </dd>
                        
                        <dt class="col-sm-6">Created:</dt>
                        <dd class="col-sm-6 text-end">{{ object.created_at|date:"M d, Y" }}</dd>
                    </dl>
                    
                    {% if object.expense_count == 0 %}
                        <div class="d-grid gap-2">
                            <form action="{% url 'expenses:category_delete' object.id %}" method="post" class="d-inline">
                                {% csrf_token %}
                                <button type="submit" 
                                        class="btn btn-outline-danger w-100"
                                        onclick="return confirm('Are you sure you want to delete this category? This action cannot be undone.');">
                                    <i class="bi bi-trash"></i> Delete Category
                                </button>
                            </form>
                        </div>
                    {% else %}
                        <div class="alert alert-warning mb-0">
                            <i class="bi bi-exclamation-triangle-fill me-2"></i>
                            Cannot delete category with associated expenses.
                        </div>
                    {% endif %}
                </div>
            </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Form validation
(function () {
    'use strict'
    
    // Fetch all the forms we want to apply custom Bootstrap validation styles to
    const forms = document.querySelectorAll('.needs-validation')
    
    // Loop over them and prevent submission
    Array.from(forms).forEach(form => {
        form.addEventListener('submit', event => {
            if (!form.checkValidity()) {
                event.preventDefault()
                event.stopPropagation()
            }
            
            form.classList.add('was-validated')
        }, false)
    })
})()

// Color picker functionality
document.addEventListener('DOMContentLoaded', function() {
    // Initialize tooltips
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
    
    // Handle color selection
    const colorInputs = document.querySelectorAll('input[name="color"]');
    const selectedColorInput = document.getElementById('selectedColor');
    const customColorInput = document.getElementById('customColorInput');
    const customColorLabel = document.querySelector('label[for="customColor"]');
    
    // Update selected color when a color is picked
    colorInputs.forEach(input => {
        input.addEventListener('change', function() {
            if (this.id === 'customColor') {
                customColorInput.click(); // Open color picker
            } else {
                selectedColorInput.value = this.value;
            }
        });
    });
    
    // Handle custom color selection
    customColorInput.addEventListener('input', function() {
        const customColor = this.value;
        customColorLabel.style.backgroundColor = customColor;
        document.getElementById('customColor').value = customColor;
        selectedColorInput.value = customColor;
        
        // Update the checked state
        document.getElementById('customColor').checked = true;
    });
    
    // Set initial custom color
    const customColor = customColorInput.value;
    customColorLabel.style.backgroundColor = customColor;
    
    // Update hidden input with the selected color
    const selectedRadio = document.querySelector('input[name="color"]:checked');
    if (selectedRadio) {
        selectedColorInput.value = selectedRadio.value;
    }
});
</script>
{% endblock %}
